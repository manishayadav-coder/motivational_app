<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body class="bg">

  <!-- ✅ Navbar -->
  <nav class="navbar">
    <a href="index.html">🏠 Home</a>
    <a href="feed.html">📢 Feed</a>
    <a href="post.html">➕ Post</a>
    <a href="favourite.html">⭐ Favourites</a>
    <a href="profile.html">👤 Profile</a>
    <a href="login.html" onclick="logout()">🚪 Logout</a>
  </nav>

  <div class="container card" id="profileContainer">
    <!-- View Section -->
    <section id="viewSection" style="display:none;">
      <h1>👤 Profile</h1>
      <div class="profile-view">
        <img id="viewAvatar" alt="Avatar" class="avatar-lg" />
        <div>
          <h2 id="viewUsername">@username</h2>
          <p id="viewBio" class="muted">No bio added yet.</p>
        </div>
      </div>

      <div class="buttons" id="viewButtons">
        <!-- Buttons injected based on mode -->
      </div>
    </section>

    <!-- Edit Section -->
    <section id="editSection" style="display:none;">
      <h1>⚙️ Edit Profile</h1>

      <div class="form-group">
        <label>Username</label>
        <input type="text" id="username" />
      </div>

      <div class="form-group">
        <label>Avatar URL</label>
        <input type="text" id="avatar" placeholder="Paste image link" />
        <small class="muted">Tip: किसी इमेज का public URL दें (जैसे Cloudinary/Imgur)।</small>
      </div>

      <div class="form-group">
        <label>Bio</label>
        <textarea id="bio" rows="3" placeholder="Say something about you..."></textarea>
      </div>

      <div class="form-group">
        <label>New Password (optional)</label>
        <input type="password" id="password" placeholder="Leave empty to keep current password"/>
      </div>

      <div class="buttons">
        <button id="saveBtn" class="btn-primary">💾 Save Changes</button>
        <button id="cancelEdit" class="btn-secondary">⬅ Cancel</button>
      </div>
    </section>
  </div>

  <script>
    // ========= Config =========
    // Deploy करने के बाद इसे अपने backend base URL से बदलें:
    const API_BASE = localStorage.getItem("API_BASE") || "http://localhost:5000";

    // ========= Helpers =========
    function logout(){
      localStorage.clear();
      alert("You have been logged out!");
      window.location.href = "login.html";
    }

    function getQueryParam(key){
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    function safeParse(jsonStr){
      try { return JSON.parse(jsonStr); } catch { return null; }
    }

    function show(el){ el.style.display = ""; }
    function hide(el){ el.style.display = "none"; }

    // ========= DOM =========
    const viewSection   = document.getElementById("viewSection");
    const editSection   = document.getElementById("editSection");
    const viewAvatar    = document.getElementById("viewAvatar");
    const viewUsername  = document.getElementById("viewUsername");
    const viewBio       = document.getElementById("viewBio");
    const viewButtons   = document.getElementById("viewButtons");

    const usernameInput = document.getElementById("username");
    const avatarInput   = document.getElementById("avatar");
    const bioInput      = document.getElementById("bio");
    const passwordInput = document.getElementById("password");

    const saveBtn       = document.getElementById("saveBtn");
    const cancelEditBtn = document.getElementById("cancelEdit");

    // ========= Auth Guard =========
    const token = localStorage.getItem("token");
    const me    = safeParse(localStorage.getItem("user")); // { id/_id, username, ... }

    if(!token || !me){
      // Not logged in -> redirect
      window.location.href = "login.html";
    }

    // ========= Mode Detect =========
    // feed.html से: profile.html?id=USER_ID
    // self view: id absent -> use me.id/_id
    const urlId  = getQueryParam("id");
    const myId   = me?.id || me?._id || null;
    const viewId = urlId || myId;

    const isSelf = (myId && viewId && String(myId) === String(viewId));

    // ========= Load Profile (View Mode) =========
    async function loadProfile(userId){
      try {
        const res = await fetch(`${API_BASE}/api/users/${userId}`, {
          headers: { "Authorization": "Bearer " + token }
        });
        if(!res.ok) throw new Error("Failed to fetch user");
        const user = await res.json();

        // Fill view
        viewAvatar.src = user.avatar || "image/a1.jpg";
        viewUsername.textContent = user.username ? `@${user.username}` : "@user";
        viewBio.textContent = user.bio || "No bio added yet.";

        // Fill edit (only for self)
        if(isSelf){
          usernameInput.value = user.username || "";
          avatarInput.value   = user.avatar || "";
          bioInput.value      = user.bio || "";
        }

        // Buttons in view
        viewButtons.innerHTML = "";
        if(isSelf){
          // Self profile: Edit + Back
          const editBtn = document.createElement("button");
          editBtn.className = "btn-primary";
          editBtn.textContent = "✏️ Edit Profile";
          editBtn.onclick = () => {
            hide(viewSection);
            show(editSection);
          };

          const backBtn = document.createElement("button");
          backBtn.className = "btn-secondary";
          backBtn.textContent = "⬅ Back to Feed";
          backBtn.onclick = () => { window.location.href = "feed.html"; };

          viewButtons.appendChild(editBtn);
          viewButtons.appendChild(backBtn);
        } else {
          // Someone else's profile: Back only
          const backBtn = document.createElement("button");
          backBtn.className = "btn-secondary";
          backBtn.textContent = "⬅ Back to Feed";
          backBtn.onclick = () => { window.location.href = "feed.html"; };
          viewButtons.appendChild(backBtn);
        }

        // Show correct section by default
        show(viewSection);
        if(isSelf){ hide(editSection); }
      } catch (err){
        console.error(err);
        alert("Unable to load profile. Redirecting to Feed.");
        window.location.href = "feed.html";
      }
    }

    // ========= Save Profile (Edit Mode) =========
    saveBtn.addEventListener("click", async () => {
      const username = usernameInput.value.trim();
      const avatar   = avatarInput.value.trim();
      const bio      = bioInput.value.trim();
      const password = passwordInput.value; // optional

      if(!username){
        alert("Username is required.");
        return;
      }

      // Build body (avoid sending empty password)
      const body = { username, avatar, bio };
      if(password && password.length > 0) body.password = password;

      try {
        const res = await fetch(`${API_BASE}/api/users/update`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        if(!res.ok){
          alert(data?.message || "❌ Failed to update profile");
          return;
        }

        // Update local cache
        localStorage.setItem("user", JSON.stringify(data));
        alert("✅ Profile updated successfully!");

        // Reset password field
        passwordInput.value = "";

        // Refresh view
        await loadProfile(myId);
        show(viewSection);
        hide(editSection);
      } catch (err){
        console.error(err);
        alert("❌ Something went wrong while updating.");
      }
    });

    // ========= Cancel Edit =========
    cancelEditBtn.addEventListener("click", () => {
      show(viewSection);
      hide(editSection);
    });

    // ========= Init =========
    (async function init(){
      // By default open view
      hide(editSection);
      hide(viewSection);
      await loadProfile(viewId);
    })();
  </script>

  <style>
    /* Optional small helpers (UI intact रहे) */
    .profile-view { display:flex; gap:16px; align-items:center; }
    .avatar-lg { width:96px; height:96px; border-radius:50%; object-fit:cover; }
    .muted { opacity:0.8; }
  </style>
</body>
</html>
