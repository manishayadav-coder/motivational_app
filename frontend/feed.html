<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Feed</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .feed-video {
      width: 100%;
      height: auto;
      border-radius: 8px;
      cursor: pointer;
    }
    .feed-img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      cursor: pointer;
    }
    .modal-video {
      width: 100%;
      max-height: 400px;
      border-radius: 8px;
    }
    .modal-img {
      width: 100%;
      max-height: 400px;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg">

  <!-- ‚úÖ Navbar -->
  <nav class="navbar">
    <a href="index.html">üè† Home</a>
    <a href="feed.html">üì¢ Feed</a>
    <a href="post.html">‚ûï Post</a>
    <a href="favourite.html">‚≠ê Favourites</a>
    <a href="profile.html">üë§ Profile</a>
    <a href="login.html" onclick="logout()">üö™ Logout</a>
  </nav>

  <div class="container card">
    <h1>üì¢ Feed</h1>
    <button onclick="location.href='post.html'" class="btn-primary">+ Create Post</button>
    <div id="feed" class="grid-feed"></div>
  </div>

  <!-- üî• Post Modal -->
  <div id="postModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const API_BASE = "https://motivational-app-m9bi.onrender.com";

    function logout(){
      localStorage.clear();
      alert("You have been logged out!");
      window.location.href = "login.html";
    }

    async function loadFeed() {
      try {
        let res = await fetch(`${API_BASE}/posts`, {
          headers: { "Authorization": "Bearer " + (localStorage.getItem("token") || "") }
        });

        if (!res.ok) throw new Error("Failed to fetch feed");

        let posts = await res.json();
        const feed = document.getElementById("feed");
        feed.innerHTML = "";

        if (!posts.length) {
          feed.innerHTML = "<p>No posts yet. Be the first one to post!</p>";
          return;
        }

        posts.forEach((p, index) => {
          const div = document.createElement("div");
          div.className = "grid-item";
          
          if (p.type === "video") {
            div.innerHTML = `
              <video controls class="feed-video" onclick="openModal(${index})">
                <source src="${p.file}" type="video/mp4"/>
              </video>
            `;
          } else {
            div.innerHTML = `
              <img src="${p.file}" alt="post image" class="feed-img" onclick="openModal(${index})"/>
            `;
          }

          feed.appendChild(div);
        });

        window.allPosts = posts;
      } catch (err) {
        console.error(err);
        document.getElementById("feed").innerHTML = "<p>‚ö†Ô∏è Could not load feed. Please try again.</p>";
      }
    }

    function openModal(index) {
      const p = window.allPosts[index];
      const modalBody = document.getElementById("modalBody");

      let mediaHTML = "";
      if (p.type === "video") {
        mediaHTML = `
          <video controls class="modal-video">
            <source src="${p.file}" type="video/mp4"/>
          </video>
        `;
      } else {
        mediaHTML = `<img src="${p.file}" alt="post image" class="modal-img"/>`;
      }

      modalBody.innerHTML = `
        <h3>${p.name || "Anonymous"}</h3>
        ${mediaHTML}
        <p>${p.quote || ""}</p>
        <button onclick="deletePost('${p._id || p.id}')">üóë Delete</button>
      `;
      document.getElementById("postModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("postModal").style.display = "none";
    }

    async function deletePost(id){
      if (!confirm("Delete this post?")) return;
      await fetch(`${API_BASE}/posts/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + (localStorage.getItem("token") || "") }
      });
      loadFeed();
      closeModal();
    }

    loadFeed();
  </script>
</body>
</html>
