<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Feed</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .feed-video {
      width: 100%;
      height: auto;
      border-radius: 8px;
      cursor: pointer;
    }
    .modal-video {
      width: 100%;
      max-height: 400px;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg">

  <!-- ‚úÖ Navbar -->
  <nav class="navbar">
    <a href="index.html">üè† Home</a>
    <a href="feed.html">üì¢ Feed</a>
    <a href="post.html">‚ûï Post</a>
    <a href="favourite.html">‚≠ê Favourites</a>
    <a href="profile.html">üë§ Profile</a>
    <a href="login.html" onclick="logout()">üö™ Logout</a>
  </nav>

  <div class="container card">
    <h1>üì¢ Feed</h1>
    <button onclick="location.href='post.html'" class="btn-primary">+ Create Post</button>
    <div id="feed" class="grid-feed"></div>
  </div>

  <!-- üî• Post Modal -->
  <div id="postModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    // üîπ Logout function
    function logout(){
      localStorage.clear();
      alert("You have been logged out!");
      window.location.href = "login.html";
    }

    async function loadFeed() {
      try {
        let res = await fetch("http://localhost:5000/api/posts/feed", {
          headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
        });

        if (!res.ok) throw new Error("Failed to fetch feed");

        let posts = await res.json();
        const feed = document.getElementById("feed");
        feed.innerHTML = "";

        if (!posts.length) {
          feed.innerHTML = "<p>No posts yet. Be the first one to post!</p>";
          return;
        }

        posts.forEach((p, index) => {
          const div = document.createElement("div");
          div.className = "grid-item";
          
          // ‚úÖ Show video if type=video else image
          if (p.type === "video") {
            div.innerHTML = `
              <video controls class="feed-video" onclick="openModal(${index})">
                <source src="${p.videoUrl}" type="video/mp4"/>
                Your browser does not support the video tag.
              </video>
            `;
          } else {
            div.innerHTML = `
              <img src="${p.image}" alt="post image" onclick="openModal(${index})"/>
            `;
          }

          feed.appendChild(div);
        });

        // Save posts globally for modal
        window.allPosts = posts;
      } catch (err) {
        console.error(err);
        document.getElementById("feed").innerHTML = "<p>‚ö†Ô∏è Could not load feed. Please try again.</p>";
      }
    }

    function openModal(index) {
      const p = window.allPosts[index];
      const modalBody = document.getElementById("modalBody");

      let mediaHTML = "";
      if (p.type === "video") {
        mediaHTML = `
          <video controls class="modal-video">
            <source src="${p.videoUrl}" type="video/mp4"/>
          </video>
        `;
      } else {
        mediaHTML = `<img src="${p.image}" alt="post image" class="modal-img"/>`;
      }

      modalBody.innerHTML = `
        <h3><a href="profile.html?id=${p.user._id}">@${p.user.username}</a></h3>
        ${mediaHTML}
        <p>${p.caption}</p>
        <button onclick="likePost('${p._id}')">‚ù§Ô∏è ${p.likes.length}</button>
        <button onclick="commentPost('${p._id}')">üí¨ Comment</button>
        <div class="comments">
          ${p.comments.length 
            ? p.comments.map(c => `<p><b>${c.user?.username || "User"}</b>: ${c.text}</p>`).join("") 
            : "<p>No comments yet.</p>"
          }
        </div>
      `;
      document.getElementById("postModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("postModal").style.display = "none";
    }

    async function likePost(id){
      await fetch(`http://localhost:5000/api/posts/${id}/like`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
      });
      loadFeed();
    }

    async function commentPost(id){
      const text = prompt("Enter comment:");
      if(!text) return;
      await fetch(`http://localhost:5000/api/posts/${id}/comment`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Authorization": "Bearer " + localStorage.getItem("token")
        },
        body: JSON.stringify({ text })
      });
      loadFeed();
    }

    loadFeed();
  </script>
</body>
</html>
